# UniBee HQ — Copilot Agent Instructions

## Overview

UniBee is an open-source SaaS billing platform. This is the **monorepo orchestrator** (`unibee-hq`) that ties together three submodule repositories, infrastructure configs, and database migrations.

## Repository Structure

```
unibee-hq/                          ← you are here (orchestrator)
├── unibee-api/                     ← Git submodule → qwertyhq/unibee-api-hq (Go / GoFrame)
├── unibee-admin-portal/            ← Git submodule → qwertyhq/unibee-admin-portal-hq (React / Vite / TS)
├── unibee-user-portal/             ← Git submodule → qwertyhq/unibee-user-portal-hq (React / Vite / TS)
├── docker-compose.yaml             ← Local dev & deploy: MySQL 8, Redis 6, API, Admin, User portals, License API
├── Caddyfile                       ← Reverse proxy (production)
├── nginx.conf                      ← Reverse proxy (alternative, currently disabled)
├── mysql/
│   ├── init.sql                    ← Bootstrap entrypoint (sources structure.sql)
│   ├── structure.sql               ← Full database schema (all core tables)
│   └── scenario_engine.sql         ← Scenario Engine migration (5 tables)
├── kubernetes/                     ← K8s manifests for all services
├── docs/
│   └── scenario-engine-plan.md     ← Architecture plan for Scenario Engine feature
└── .github/
    ├── workflows/                  ← CI: release, commit linting, sub-project releases
    ├── ISSUE_TEMPLATE.md
    └── PULL_REQUEST_TEMPLATE.md
```

## Tech Stack

### Backend — `unibee-api` (Go)

| Layer | Tech |
|---|---|
| Framework | [GoFrame v2](https://goframe.org/) (gf/v2) |
| Language | Go 1.22 |
| Database | MySQL 8 via `gogf/gf/contrib/drivers/mysql/v2` |
| Cache/Queue | Redis 6 via `gogf/gf/contrib/nosql/redis/v2`, `go-redismq` |
| Auth | JWT (`golang-jwt/jwt/v5`), TOTP (`pquerna/otp`) |
| Payments | Stripe (`stripe/stripe-go/v78`) |
| Email | SendGrid (`sendgrid/sendgrid-go`) |
| Telegram | `go-telegram/bot` |
| Testing | `stretchr/testify` |

**Architecture (3 layers, GoFrame convention):**
```
internal/
├── controller/        ← HTTP handlers (thin, validate + delegate)
│   ├── merchant/      ← Merchant admin API controllers
│   ├── user/          ← End-user API controllers
│   ├── checkout/      ← Payment checkout controllers
│   └── system/        ← System/platform controllers
├── logic/             ← Business logic (the core domain layer)
│   ├── subscription/  ← Subscription management
│   ├── invoice/       ← Invoice generation
│   ├── payment/       ← Payment processing
│   ├── plan/          ← Plan/product management
│   ├── gateway/       ← Payment gateway integrations
│   ├── scenario/      ← Scenario Engine (automation/workflows)
│   ├── telegram/      ← Telegram bot logic
│   ├── email/         ← Email sending
│   ├── webhook/       ← Webhook handling
│   ├── discount/      ← Discount/promo code logic
│   ├── user/          ← User management
│   ├── merchant/      ← Merchant management
│   ├── credit/        ← Credit balance management
│   ├── metric/        ← Billable metrics
│   └── ...            ← Other domain modules
├── model/             ← Data structures (entity, DO, DTO)
├── dao/               ← Database access objects (auto-generated by GoFrame)
├── query/             ← Complex queries
├── consumer/          ← Async message consumers
├── cronjob/           ← Scheduled jobs
├── consts/            ← Constants
├── driver/            ← External service drivers
├── interface/         ← Go interfaces for dependency inversion
└── permission/        ← RBAC / permission logic
```

### Frontend — `unibee-admin-portal` / `unibee-user-portal` (React)

| Layer | Tech |
|---|---|
| Framework | React 18 + TypeScript 5.5 |
| Build | Vite 7 |
| UI Library | Ant Design 5 |
| Styling | Tailwind CSS 3, PostCSS |
| State | Zustand |
| Routing | React Router 6 |
| HTTP | Axios |
| Linting | ESLint 9 + typescript-eslint |
| Formatting | Prettier |
| Testing | Jest + ts-jest |
| Flow Editor | @xyflow/react 12 + @dagrejs/dagre (Scenario Engine visual editor) |

**Admin Portal structure:**
```
src/
├── components/        ← Feature modules (each folder = one domain feature)
│   ├── subscription/  ← Subscription management UI
│   ├── invoice/       ← Invoice views
│   ├── payment/       ← Payment views
│   ├── plan/          ← Plan/product management
│   ├── user/          ← User management
│   ├── scenario/      ← Scenario Engine (automation workflows)
│   ├── settings/      ← Settings pages
│   ├── analytics/     ← Analytics dashboard
│   ├── discountCode/  ← Discount management
│   ├── credit/        ← Credit management
│   ├── shared/        ← Shared/reusable components
│   ├── ui/            ← Primitive UI components
│   ├── table/         ← Table components
│   ├── sidebar/       ← Navigation sidebar
│   └── ...
├── requests/          ← API client layer (one file per service domain)
│   ├── index.ts       ← Main API functions (large, split by domain)
│   ├── client.ts      ← Axios instance config
│   └── *Service.ts    ← Domain-specific API services
├── stores/            ← Zustand stores
├── hooks/             ← Custom React hooks
├── helpers/           ← Utility/helper functions
├── utils/             ← Utility functions
├── services/          ← Service layer
├── @types/            ← TypeScript type declarations
├── routes.tsx         ← Route definitions
├── shared.types.ts    ← Shared TypeScript interfaces
├── constants.ts       ← App-wide constants
└── main.tsx           ← Entry point
```

### Infrastructure

| Service | Config |
|---|---|
| Docker Compose | `docker-compose.yaml` — MySQL, Redis, API, Admin Portal, User Portal, License API, Caddy network |
| Caddy | `Caddyfile` — TLS-terminating reverse proxy |
| Nginx | `nginx.conf` — Alternative reverse proxy (disabled, Caddy preferred) |
| Kubernetes | `kubernetes/*.yaml` — Deployments, Services, ConfigMaps for all components |
| Database | MySQL 8.0.37, `utf8mb4_unicode_ci`, auto-init via `mysql/init.sql` |
| Cache | Redis 6 with password auth |

## Coding Conventions

### ⛔ Anti-patterns to AVOID

**1. "Christmas Tree" / Deep Nesting**
```go
// ❌ BAD — code Christmas tree
func handler(ctx context.Context, req *Request) error {
    if req != nil {
        if req.UserID > 0 {
            user, err := getUser(req.UserID)
            if err == nil {
                if user.Active {
                    sub, err := getSub(user.ID)
                    if err == nil {
                        // 5 levels deep...
                    }
                }
            }
        }
    }
    return nil
}

// ✅ GOOD — early returns (guard clauses)
func handler(ctx context.Context, req *Request) error {
    if req == nil || req.UserID <= 0 {
        return errors.New("invalid request")
    }

    user, err := getUser(req.UserID)
    if err != nil {
        return fmt.Errorf("get user: %w", err)
    }
    if !user.Active {
        return errors.New("user inactive")
    }

    sub, err := getSub(user.ID)
    if err != nil {
        return fmt.Errorf("get subscription: %w", err)
    }
    // flat logic continues...
}
```

**2. God Functions / Mega Components**
```typescript
// ❌ BAD — 500-line React component with everything inline
const MegaPage = () => {
  // ...50 useState hooks, API calls, rendering, event handlers...
}

// ✅ GOOD — split into composable parts
// hooks/useSubscription.ts — data fetching
// components/subscription/SubscriptionTable.tsx — rendering
// components/subscription/SubscriptionActions.tsx — actions
```

**3. Direct DOM Manipulation / Hardcoded Strings**
```typescript
// ❌ BAD
document.getElementById('btn').style.display = 'none'
const API_URL = 'http://localhost:8088/api'

// ✅ GOOD
const [visible, setVisible] = useState(true)
const apiUrl = import.meta.env.VITE_API_URL
```

### ✅ Patterns to FOLLOW

**Go Backend:**
- **Controller** = thin HTTP handler: validate input → call logic → return response
- **Logic** = business rules, domain operations, transaction boundaries
- **DAO** = database CRUD (auto-generated, do not edit manually)
- **Model** = entity structs matching DB tables + DTOs for API responses
- Use `context.Context` everywhere, never background goroutines without context
- Wrap errors with `fmt.Errorf("operation: %w", err)` for stack traces
- Use GoFrame ORM patterns: `dao.Table.Ctx(ctx).Where(...).Scan(&result)`
- Keep functions under 50 lines; extract helpers when logic grows

**React Frontend:**
- One feature = one folder under `components/`
- API functions go in `requests/` — never call axios directly from components
- State management via Zustand stores in `stores/`
- Use Ant Design components; avoid custom CSS when AntD has a component
- TypeScript strict mode — no `any` unless absolutely necessary
- Custom hooks in `hooks/` for reusable logic (data fetching, form handling)
- React Router 6 patterns — routes defined in `routes.tsx`

**Database:**
- All tables use `utf8mb4_unicode_ci`, InnoDB engine
- Standard columns: `id` (BIGINT AUTO_INCREMENT PK), `gmt_create`, `gmt_modify`, `is_deleted`, `create_time`
- Soft deletes via `is_deleted` (0=active, 1=deleted)
- Add indexes for frequently queried columns
- Migration files go in `mysql/` directory

## Development Workflow

### Local Development
```bash
# Start infrastructure (MySQL + Redis)
docker compose up db redis -d

# API (Go) — in unibee-api/
cd unibee-api && go run main.go

# Admin Portal (React) — in unibee-admin-portal/
cd unibee-admin-portal && yarn && yarn dev

# User Portal (React) — in unibee-user-portal/
cd unibee-user-portal && yarn && yarn dev
```

### Build & Test
```bash
# Go API
cd unibee-api && go build ./... && go test ./...

# Admin Portal
cd unibee-admin-portal && yarn build    # tsc + vite build
cd unibee-admin-portal && yarn lint     # eslint
cd unibee-admin-portal && yarn test     # jest

# User Portal
cd unibee-user-portal && yarn build
```

### Full Stack (Docker Compose)
```bash
docker compose up --build
# API:          http://localhost:8088
# Admin Portal: http://localhost:8081
# User Portal:  http://localhost:8082
```

## Key Domain Concepts

- **Merchant** — a SaaS business using UniBee (multi-tenant by `merchant_id`)
- **Plan** — a subscription plan with pricing, intervals, features
- **Subscription** — a user's active plan with billing cycle
- **Invoice** — generated per billing cycle or one-time charge
- **Payment** — a transaction via Stripe or other gateway
- **Gateway** — payment provider integration (Stripe, etc.)
- **Discount/Promo** — coupon codes with percentage or fixed discounts
- **Credit** — prepaid balance for users
- **Metric** — usage-based billing metric
- **Webhook** — event notifications to external systems
- **Scenario** — automated workflow (Scenario Engine: triggers → steps → actions)

## Where to Make Changes

| Task | Where |
|---|---|
| New API endpoint | `unibee-api/api/` (define), `internal/controller/` (handler), `internal/logic/` (business logic) |
| New admin UI page | `unibee-admin-portal/src/components/<feature>/`, add route in `routes.tsx` |
| New user-facing page | `unibee-user-portal/src/components/<feature>/` |
| Database migration | `mysql/` directory (new SQL file), update `structure.sql` if core table |
| New API request function | `unibee-admin-portal/src/requests/` |
| Docker/infra changes | `docker-compose.yaml`, `Caddyfile`, `kubernetes/` |
| New cron job | `unibee-api/internal/cronjob/` |
| Webhook handler | `unibee-api/internal/logic/webhook/` |

## Important Notes

- Submodules are separate repos — changes to API/portals go in their respective repos
- The monorepo (`unibee-hq`) manages: docker-compose, database migrations, Caddy/Nginx configs, K8s manifests, and documentation
- Always check `docs/scenario-engine-plan.md` before working on the Scenario Engine feature
- CI uses conventional commits — follow the format: `feat:`, `fix:`, `chore:`, `docs:`
- Releases are triggered by merging `release/vX.Y.Z` branches
